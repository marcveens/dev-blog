export async function save(
  saveJson: SavedFile,
  options?: SaveOptions,
  handlers?: SaveEventHandlers
) {
  const save_text = JSON.stringify(saveJson);
  const blob = new Blob([save_text], { type: "text/plain;charset=utf-8" });
  const newFilename = options?.filename || `${format(new Date(), 'yyyyMMddHHmmss')}DinoNetwerk.json`; // In case of chromium the user can overwrite this

  if (window.showSaveFilePicker) {
    // Check if saveFilePicker is supported
    try {
      let fileHandle: FileSystemFileHandle | undefined;

      if (window.cachedFileHandle && !options?.forceSaveAs) {
        fileHandle = window.cachedFileHandle;
      } else {
        fileHandle = await createSaveFilePicker(newFilename);
        window.cachedFileHandle = fileHandle;
      }

      writeBlobToFileHandler(fileHandle, blob);

      handlers?.onSave?.();
    } catch (error: any) {
      if (error instanceof Error) {
        if (error.name !== "AbortError") {
          if (handlers?.onError) {
            handlers.onError("Could not save file", error);
          }
        }
      }
    }
  } else {
    // No picker support, save to Downloads folder
    saveAs(blob, newFilename);

    handlers?.onSave?.();
  }
}